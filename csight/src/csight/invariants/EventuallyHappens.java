package csight.invariants;

import java.util.List;

import csight.invariants.checkers.EventuallyChecker;

import synoptic.model.event.DistEventType;

/**
 * Represents an "X eventually happens" invariant type.
 */
public class EventuallyHappens extends BinaryInvariant {

    public EventuallyHappens(DistEventType event) {
        super(DistEventType.INITIALEventType, event, "Eventually");
    }

    public DistEventType getEvent() {
        return this.getSecond();
    }

    @Override
    public void checkInitialized() {
        // Override the initialization checking to just check for the first
        // synthetic events pair, since this invariant type does not use the
        // second pair.
        assert firstSynth1 != null;
        assert secondSynth1 != null;
    }

    @Override
    public String scmBadStateQRe() {
        // There are 0 occurrences of 'X'.
        return "_";
    }

    @Override
    public String promelaNeverClaim() {
        // Never claim generated by Spin with command
        // spin -f "!(<>(b))";
        // Then, we substitute b for our conditional.

        // The never claim will be accepted if the invariant is false.

        String ret = "";
        ret += String.format("never { /* !(<>(%s)) */\n",
                second.toPromelaString());
        ret += "accept_init:\n";
        ret += "T0_init:\n";
        ret += "    do\n";
        ret += String.format("      :: (! %s ) -> goto T0_init\n",
                secondNeverEvent());
        ret += "    od;\n";
        ret += "}\n";
        return ret;
    }

    @Override
    public boolean satisfies(List<DistEventType> eventsPath) {
        for (DistEventType e : eventsPath) {
            if (e.equals(second)) {
                return true;
            }
        }
        // Never saw 'second' => eventually 'second' is false.
        return false;
    }

    @Override
    public EventuallyChecker newChecker() {
        return new EventuallyChecker(this);
    }
}
